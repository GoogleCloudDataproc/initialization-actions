#!/bin/bash
#
[% INSERT legal/license_header %]
#
[% PROCESS common/template_disclaimer %]
#
# This initialization action script will install rapids on a Dataproc
# cluster.

set -euxo pipefail

[% INSERT common/util_functions %]

[% INSERT gpu/util_functions %]

[% INSERT dask/util_functions %]

function main() {
  # Install Dask with RAPIDS
  install_dask_rapids

  # In "standalone" mode, Dask relies on a systemd unit to launch.
  # In "yarn" mode, it relies a config.yaml file.
  if [[ "${DASK_RUNTIME}" == "yarn" ]]; then
    # Create cuda accelerated Dask YARN config file
    configure_dask_yarn
    echo "yarn setup complete"
  else
    # Create Dask service
    install_systemd_dask_service
    start_systemd_dask_service

    configure_knox_for_dask

    local DASK_CLOUD_LOGGING="$(get_metadata_attribute dask-cloud-logging 'false')"
    if [[ "${DASK_CLOUD_LOGGING}" == "true" ]]; then
      configure_fluentd_for_dask
    fi
  fi
}

function exit_handler() {
  gpu_exit_handler
  pip_exit_handler
  conda_exit_handler
  common_exit_handler
  return 0
}

function prepare_to_install(){
  prepare_common_env
  conda_env="$(get_metadata_attribute conda-env 'dask-rapids')"
  readonly conda_env
  prepare_dask_rapids_env
  prepare_conda_env
  prepare_pip_env
  prepare_gpu_env
  trap exit_handler EXIT
}

prepare_to_install

main
