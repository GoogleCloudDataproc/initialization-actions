#!/bin/bash
#
[% INSERT legal/license_header %]
#
[% PROCESS common/template_disclaimer %]
#
# This script installs NVIDIA GPU drivers and collects GPU utilization metrics.

set -euxo pipefail

[% INSERT common/util_functions %]

[% INSERT common/install_functions %]

[% INSERT gpu/util_functions %]

[% INSERT gpu/install_functions %]

[% INCLUDE gpu/yarn_functions %]

[% INSERT gpu/spark_functions %]

function main() {
  install_gpu_driver_and_cuda

  #Install GPU metrics collection in Stackdriver if needed
  if [[ "${INSTALL_GPU_AGENT}" == "true" ]]; then
    install_gpu_agent
#    install_gpu_monitoring_agent
    echo 'GPU metrics agent successfully deployed.'
  else
    echo 'GPU metrics agent has not been installed.'
  fi
  configure_gpu_exclusive_mode

  setup_gpu_yarn

  echo "yarn setup complete"

  if ( test -v CUDNN_VERSION && [[ -n "${CUDNN_VERSION}" ]] ) ; then
    install_nvidia_nccl
    install_nvidia_cudnn
  fi

  if [[ "${RAPIDS_RUNTIME}" == "SPARK" ]]; then
    install_spark_rapids
    configure_gpu_script
    echo "RAPIDS initialized with Spark runtime"
  elif [[ "${RAPIDS_RUNTIME}" == "DASK" ]]; then
    # we are not currently tooled for installing dask in this action.
    echo "RAPIDS recognizes DASK runtime - currently supported using dask/dask.sh or rapids/rapids.sh"
  else
    echo "Unrecognized RAPIDS Runtime: ${RAPIDS_RUNTIME}"
  fi

  echo "main complete"
  return 0
}

function exit_handler() {
  gpu_install_exit_handler
  gpu_exit_handler
  pip_exit_handler
  yarn_exit_handler
  common_exit_handler
  return 0
}

function prepare_to_install(){
  prepare_common_env
  prepare_pip_env
  prepare_gpu_env
  prepare_gpu_install_env
  trap exit_handler EXIT
}

prepare_to_install

main
