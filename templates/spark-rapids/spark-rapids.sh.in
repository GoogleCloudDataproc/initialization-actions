#!/bin/bash
#
[% INSERT legal/license_header %]
#
[% PROCESS common/template_disclaimer %]
#
# This script installs NVIDIA GPU drivers.
#
# Dataproc 2.0:  Driver version 530.30.02, CUDA version 12.1.1, Rapids 23.08.2
# Dataproc 2.1:  Driver version   550.135, CUDA version 12.4.1, Rapids 24.08.1
# Dataproc 2.2:  Driver version 560.35.03, CUDA version 12.6.2, Rapids 24.08.1
#
# Additionally, it installs the RAPIDS Spark plugin, configures Spark
# and YARN, and installs an agent to collect GPU utilization metrics.
# The installer is regularly exercised with Debian, Ubuntu, and Rocky
# Linux distributions.
#
# Note that the script is designed to work both when secure boot is
# enabled with a custom image and when disabled during cluster
# creation.
#
# For details see
# github.com/GoogleCloudDataproc/custom-images/tree/main/examples/secure-boot
#
[% PROCESS common/template_disclaimer %]

set -euxo pipefail

[% INSERT common/util_functions %]

[% INSERT gpu/util_functions %]

function main() {
  setup_gpu_yarn

  echo "yarn setup complete"

  if [[ "${RAPIDS_RUNTIME}" == "SPARK" ]]; then
    install_spark_rapids
    configure_gpu_script
    echo "RAPIDS initialized with Spark runtime"
  elif [[ "${RAPIDS_RUNTIME}" == "DASK" ]]; then
    # we are not currently tooled for installing dask in this action.
    echo "RAPIDS recognizes DASK runtime - currently supported using dask/dask.sh or rapids/rapids.sh"
  else
    echo "Unrecognized RAPIDS Runtime: ${RAPIDS_RUNTIME}"
  fi

  echo "main complete"
  return 0
}

function exit_handler() {
  gpu_exit_handler
  common_exit_handler
  return 0
}

function prepare_to_install(){
  prepare_common_env
  prepare_gpu_env
  trap exit_handler EXIT
}

prepare_to_install

main
